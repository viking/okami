<div id="sidebar">
  <h2>Library</h2>
</div>
<div id="playlist">
  <table class="playlist">
    <thead>
      <tr>
        <th>#</th>
        <th>Track</th>
        <th>Album</th>
        <th>Artist</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>
<script type="text/javascript">
  var rowTemplate = {{{playlist_row_template}}};
  function loadAlbums(artist, includeTracks, callback) {
    var params = {artist_id: artist.data('id')};
    if (includeTracks) {
      params.tracks = 'true';
    }
    $.get('/albums', params, function(data) {
      artist.append(data);
      artist.find('.album').draggable({
        revert: 'invalid',
        helper: albumHelper,
        appendTo: 'body'
      });
      if (callback) {
        callback();
      }
    }, 'html');
  }
  function loadTracks(album, callback) {
    $.get('/tracks', {album_id: album.data('id')}, function(data) {
      album.append(data);
      album.find('.track').draggable({
        revert: 'invalid',
        helper: trackHelper,
        appendTo: 'body'
      });
      if (callback) {
        callback();
      }
    }, 'html');
  }
  function artistHelper(e) {
    var artist = $(this);
    var result = $('<div class="artist"></div>');
    result.data(artist.data());
    result.html(artist.data('name'));
    return(result);
  }
  function albumHelper(e) {
    var album = $(this);
    var result = $('<div class="album"></div>');
    result.data(album.data());
    result.html(album.data('name'));
    return(result);
  }
  function trackHelper(e) {
    var track = $(this);
    var result = $('<div class="track"></div>');
    result.data(track.data());
    result.html(track.data('name'));
    return(result);
  }
  function queueTracks(tracks) {
    var playlist = $('#playlist > table');
    tracks.each(function() {
      var track = $(this);
      var view = {
        number: track.data('number'),
        track: track.data('name'),
        album: $('.album-'+track.data('album_id')).data('name'),
        artist: $('.artist-'+track.data('artist_id')).data('name')
      };
      playlist.append($.mustache(rowTemplate, view));
    });
  }
  $(function() {
    $('#playlist').droppable({
      drop: function(e, ui) {
        var obj = ui.draggable;
        var tracks;
        if (obj.hasClass('track')) {
          tracks = obj;
        }
        else {
          var which = obj.hasClass('artist') ? 'artist' : 'album';
          var selector = '#sidebar .' + which + '-' +
            obj.data('id') + ' .track';
          tracks = $(selector);
          if (tracks.length == 0) {
            if (which == 'artist') {
              loadAlbums(obj, true, function() {
                queueTracks($(selector));
              });
            }
            else {
              loadTracks(obj, function() {
                queueTracks($(selector));
              });
            }
            return;
          }
        }
        queueTracks(tracks);
      }
    });
    var sidebar = $('#sidebar');
    $.get('/artists', function(data) {
      sidebar.append(data);
      sidebar.find('.artist').draggable({
        revert: 'invalid',
        helper: artistHelper,
        appendTo: 'body'
      });
    }, 'html');

    sidebar.
      on('click', 'li.artist', function(e) {
        var artist = $(this);
        var albums = artist.find('ul');
        if (albums.length == 0) {
          loadAlbums(artist);
        }
        else {
          albums.toggle();
        }
      }).
      on('click', 'li.album', function(e) {
        e.stopPropagation();

        var album = $(this);
        var tracks = album.find('ul');
        if (tracks.length == 0) {
          loadTracks(album);
        }
        else {
          tracks.toggle();
        }
      }).
      on('click', 'li.track', function(e) {
        e.stopPropagation();
      });
  });
</script>
